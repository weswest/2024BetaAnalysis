<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bank Model Selector</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.814.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const accessKeyId = "{{ aws_access_key_id }}";
            const secretAccessKey = "{{ aws_secret_access_key }}";
            const region = 'us-east-2';

            if (accessKeyId && secretAccessKey) {
                console.log("Using credentials from environment variables.");
                AWS.config.update({
                    region: region,
                    credentials: new AWS.Credentials({
                        accessKeyId: accessKeyId,
                        secretAccessKey: secretAccessKey
                    })
                });
            } else {
                console.log("Using IAM role credentials from EC2.");
                AWS.config.update({
                    region: region
                });
            }

            // SQS Client
            const sqs = new AWS.SQS();

            function sendModelRequest() {
                const form = document.getElementById('modelForm');
                const formData = new FormData(form);
                const [bankName, cert, assets] = formData.get('bank').split(' - ');
                const model = formData.get('model');
                const sessionData = {
                    session_id: String(Date.now()),
                    ip_address: '192.168.1.1',
                    timestamp: new Date().toISOString()
                };
                const message = {
                    bank_name: bankName,
                    cert: cert,
                    assets: assets,
                    model: model,
                    session_data: sessionData
                };

                const params = {
                    MessageBody: JSON.stringify(message),
                    QueueUrl: 'https://sqs.us-east-2.amazonaws.com/471112830027/get_a_model_queue'
                };

                sqs.sendMessage(params, (err, data) => {
                    const resultDiv = document.getElementById('result');
                    if (err) {
                        console.error(err);
                        resultDiv.innerHTML = `<p>Error: ${err.message}</p>`;
                    } else {
                        console.log(data);
                        resultDiv.innerHTML = `<p>Request sent successfully. Message ID: ${data.MessageId}</p>`;
                        pollForResults(sessionData.session_id);
                    }
                });
            }

            function pollForResults(sessionId) {
                const params = {
                    QueueUrl: 'https://sqs.us-east-2.amazonaws.com/471112830027/model_results_queue',
                    MaxNumberOfMessages: 1,
                    WaitTimeSeconds: 10
                };

                const poll = () => {
                    sqs.receiveMessage(params, (err, data) => {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        if (data.Messages) {
                            data.Messages.forEach(message => {
                                const body = JSON.parse(message.Body);
                                if (body.session_data.session_id === sessionId) {
                                    displayResults(body.model_results);
                                    sqs.deleteMessage({
                                        QueueUrl: 'https://sqs.us-east-2.amazonaws.com/471112830027/model_results_queue',
                                        ReceiptHandle: message.ReceiptHandle
                                    }, (err, data) => {
                                        if (err) console.error(err);
                                    });
                                } else {
                                    setTimeout(poll, 1000);
                                }
                            });
                        } else {
                            setTimeout(poll, 1000);
                        }
                    });
                };

                poll();
            }

            function displayResults(results) {
                const resultDiv = document.getElementById('result');
                if (results.error) {
                    resultDiv.innerHTML = `<p>Error: ${results.error}</p>`;
                } else {
                    resultDiv.innerHTML = `
                        <p>Model Type: ${results.model_type}</p>
                        <p>Intercept: ${results.intercept}</p>
                        <p>Coefficient: ${results.coefficient}</p>
                    `;
                }
            }

            document.getElementById('submitButton').onclick = sendModelRequest;
        });
    </script>
</head>
<body>
    <form id="modelForm">
        <label for="bank">Select Bank:</label>
        <select id="bank" name="bank">
            {% for option in bank_options %}
                <option value="{{ option.name }} - {{ option.cert }} - {{ option.assets }}">{{ option.name }} - {{ option.cert }} - {{ option.assets }}</option>
            {% endfor %}
        </select>
        <br><br>
        <label for="model">Select Model:</label>
        <select id="model" name="model">
            <option value="error correction">Error Correction</option>
            <option value="linear regression">Linear Regression</option>
        </select>
        <br><br>
        <button type="button" id="submitButton">Get Model</button>
    </form>

    <div id="result"></div>
</body>
</html>
